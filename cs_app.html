<!DOCTYPE html>
<html lang="en" style="height: 100%;padding: 0;margin: 0">
<head>
    <meta charset="UTF-8">
    <title>CS_APP</title>
	<script>
		alert("012");
	</script>
    <script type="text/javascript" src="/data/node_test/hbbtv-app-lib.js"></script>
		<script>
		alert("456");
	</script>

</head>
<body style="height:96%" >
    <h1>CS Web Application Test</h1>
    <div style="float:left;width:48%">
        <button id="button">Discover HbbTV Terminals</button>
        <br/>
        <div id="info"></div>
        <br/>
        <ul id="terminals"></ul>
    </div>
    <div style="float:left;width:48%;height:90%" >
        <textarea id="log" style="width:98%;height:98%" disabled="true"></textarea>
    </div>

    <script>
        var log = function(msg) {
            document.getElementById("log").innerHTML += (msg + "\n");
        };

        var qualifyURL = function(url){
            var a = document.createElement('a');
            a.href = url;
            return a.href;
        }
		log("1111111111");
        var launchHbbTVApp = function(index){
            var terminal = terminals[index];
            var options = {
                "appUrlBase": qualifyURL("hbbtv-app.html"),
                "appLocation": "?channel="+channel
            };
            terminal && terminalManager.launchHbbTVApp(terminal.enum_id,options,function(res){
                log("launch app result code "+ res);
            });
        };
log("222222222222");
        var connect = function(index,url){
            var ws = new WebSocket(url);
            ws.binary = "arraybuffer";
            ws.onopen = function(evt){
                log("Connection waiting...");
                ws.send("Hello Server");
            };
            ws.onclose = function(evt){
                log("Connection closed");
            };
            ws.onerror = function(evt){
                log("ws conmunication error");
            };
            ws.onmessage = function(evt){
                if(evt.data = "pairingcompleted"){
                    log("Receved message: " + evt.data);
                    ws.onmessage = function(evt){
                        log("Receved message: " + evt.data);
                    }
                }
                else{
                    log("Unexpected message received from terminal.");
                    ws.close();
                }
            };

        }
log("3333333333333333");
        var terminalManager = hbbtv && hbbtv.createTerminalManager();
		log("44444444444444");
        var terminals = [];

     //   document.getElementById("button").onclick = function(){
            document.getElementById("info").innerHTML = "Searching for HbbTV Terminals:  please wait ...";
			
            terminals.length = 0;
            document.getElementById("button").setAttribute("disabled","true");
			log("5555555555555555");
            terminalManager.discoverTerminals(function(discoveredTernminals){
			log("6666666666666666");
                document.getElementById("button").setAttribute("disabled","true");
                terminals = discoveredTernminals;
                terminals.forEach(function(terminal,i){
				log("777777777777777777777");
                    document.getElementById("terminals").innerHTML +=
                            "<li id='"+i+"'>" + terminal.friendly_name +
                            "  <button class='launch' onclick='launchHbbTVApp("+i+")'>Launch</button> " +
                            "  <button class='connect' onclick='connect("+i+")'>Connect</button> " +
                            "<div class='log'></div> " +
                            "</li>"
                    ;
                });
                if(terminals.length==0){
                    document.getElementById("info").html("No HbbTV Terminals found. Click on the discover button to search again");
                }
                log(terminals.length+" HbbTV terminals found");
            });
       // };
    </script>
</body>
</html>